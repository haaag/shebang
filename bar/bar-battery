#!/usr/bin/env bash

# Output: [ICON  98%]
# Output: [ICON  98% status]
# ï‰„  ï‰ƒ  ï‰‚  ï‰  ï‰€
# ï–‚ ï•¹ ï•º ï•» ï•¼ ï•½ ï•¾ ï•¿ ï–€ ï– ï•¸
# ï–ƒ ï–„ ï–… ï–† ï–‡ ï–ˆ ï–‰ ï–Š
# ï–‹ ï–Œ ï– ï–Ž ï– ï–
# î¸ƒ î¸„ î¸…
# î¸€ î¸ î¸‚
# î¸ƒî¸„î¸î¸‚

PROG=$(basename "$0")
BAT_CHARGE=$(cat /sys/class/power_supply/BAT0/capacity)
BAT_STATUS=$(cat /sys/class/power_supply/BAT0/status)

# notification icons
warn="ðŸ”´"
icon_critical="ï‰„"
icon_empty="ï‰ƒ"
icon_low="ï‰‚"
icon_mid="ï‰"
icon_full="ï‰€"
icon_char="ï‡¦"

function notification_critical() {
	local hints critical_icon_noti
	critical_icon_noti="battery-level-10-symbolic"
	hints="string:x-canonical-private-synchronous:battery"

  if ! command -v dunstify >/dev/null 2>&1; then
    printf "%s: %s\n" "$PROG" "notify-send is not found"
  fi

	dunstify --urgency=critical -a "Battery" "Battery" "Battery critical: " -i "$critical_icon_noti" -h int:value:"$BAT_CHARGE" -h "${hints}"
}

function is_charching() {
	local bat_status
	bat_status=$(cat /sys/class/power_supply/BAT0/status)

	if [[ "${bat_status}" != "Charging" ]]; then
		return 1
	fi
	return 0
}

function get_icon() {
	local icon=""

	if is_charching; then
		echo "$icon_char"
		return
	fi

	if [[ "$BAT_CHARGE" -lt "20" ]]; then
		icon="$warn $icon_critical"
	elif [[ "$BAT_CHARGE" -lt "30" ]]; then
		icon="$icon_empty"
	elif [[ "$BAT_CHARGE" -lt "50" ]]; then
		icon="$icon_low"
	elif [[ "$BAT_CHARGE" -lt "90" ]]; then
		icon="$icon_mid"
	else
		icon="$icon_full"
	fi

	echo "$icon"
}

function main() {
	if [ "$BAT_CHARGE" -lt 15 ]; then
		notification_critical
	fi

	printf "%s" "$SEP1"
	printf "%b %s%%" "$(get_icon)" " $BAT_CHARGE"
	printf "%s\n" "$SEP2"
}

main
