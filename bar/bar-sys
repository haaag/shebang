#!/usr/bin/env bash

# simple systray for dwmblocks

function is_online() {
	if ! ping -q -c 1 "www.linux.org" >/dev/null; then
		return 1
	fi

	return 0
}

function get_interface() {
	local ether="eno1"
	local wlan="wlp2s0"
	declare -A interfaces
	interfaces["$ether"]="ï›¿" # "ï —" # "ï›¿"
	interfaces["$wlan"]="ï‡«"  #"ï€’" # "ï‚¬"

	local exclude="loopback"
	local status=$(nmcli device status | grep "$ether\|$wlan")
	local count=$(echo "$status" | grep -c "connected")

	if ! is_online; then
		printf "%s" "ï„§"
		return
	fi

	if [[ "$count" -lt 1 ]]; then
		printf "%s" "ï„§"
	elif [[ "$count" -eq 1 ]]; then
		local active=$(echo "$status" | grep "connected" | grep -v "$exclude" | awk '{print $1}')
		printf "%s" "${interfaces[$active]}"
	else
		printf "ğŸ”´%s" "${interfaces[*]}"
	fi
}

function get_icons() {
	icons=(ï„° ï„± ï„œ ï„¾ î™² ï‡¦ ï„§ ï‡« ï€’ ïŠ“ ïŠ” ïŠ™ ï‹ ï‹’ ï‘¶ ï‡¶ ï’¼)
	icons+=(îš“ î© î™ î• î“ îŸ… î˜« ï€ ï‹ î˜‚ ï¶ ï¬ ïª ï‚¬ ï‚­ ï‚® ïƒ¢)
	icons+=(ï›¿ ï± î­¹ î­º î­» î¯† ïŒ® ï“‡ ï“‰ ï“…)
	icons+=(ï€½ î¶­ î¸• î¼« î¼ª î½¡ î¾ î¾— î¿… î´¯)
	icons+=(î™„ î˜¸ î©° î°œ î´ƒ î¸• î¹˜ î¹™ î»¨ î¼‰ î¾ƒ ï€“ ï€” ï€¦ ï­ ïƒ¤ ï…¦ ï‡¦ ïŠ”)
}

function is_bluetooth_on() {
	if bluetoothctl show | grep -q "Powered: yes"; then
		printf "%s" "ïŠ“"
		return
	fi
}

function is_microphone_on() {
	local enable="ï„°"
	local disable="ï„±"
	local card=2
	local mic="Mic"

	amixer -c "$card" get "$mic" &>/dev/null
	local retcode=$?
	if [[ "$retcode" -ne 0 ]]; then
		return
	fi

	local mic_status
	mic_status=$(amixer -c "$card" get "$mic" | grep "Front Left:" | awk '{print $7}')

	if [[ "$mic_status" != "[on]" ]]; then
		echo "$disable"
		return
	fi

	echo "$enable"
}

function is_notifications_on() {
	if ! pgrep -x dunst >/dev/null; then
		echo "ï‡¶"
		return
	fi

	paused=$(dunstctl is-paused)
	if [[ ! $paused == "false" ]]; then
		echo "ï‡¶"
		return
	fi
}

function is_redshift_enable() {
	local enable="ï®"
	local disable="ïŠ¨" # "ï°"
	# Get the gamma values from xrandr. When redshift isn't on, all values are 1.0.
	GAMMAX=$(xrandr --verbose | grep 'Gamma' | awk -F ':' '{print $2}' | tr -d ' ')
	GAMMAY=$(xrandr --verbose | grep 'Gamma' | awk -F ':' '{print $3}' | tr -d ' ')
	GAMMAZ=$(xrandr --verbose | grep 'Gamma' | awk -F ':' '{print $4}' | tr -d ' ')

	# Check for at least one value not being 1.0. X appears to stay as 1.0, but Y and Z change.
	if [[ "$GAMMAX" != 1.0 ]] || [[ "$GAMMAY" != 1.0 ]] || [[ "$GAMMAZ" != 1.0 ]]; then
		echo "${enable}"
	else
		echo "${disable}"
	fi
}

function is_running() {
	local cmd="$1"
	local enable="$2"
	local disable="$3"

	if ! pgrep -f "$cmd" >/dev/null; then
		printf "%s" "$disable"
	else
		printf "%s" "$enable"
	fi
}

function main() {
	declare -A programs
	programs["tidal-hifi"]="ï€"
	programs["transmission-daemon"]="ï¶"
	programs["ytlocal"]="ï…ª"
	programs["ollama"]="î«˜"
	# programs["mpv"]="îšŸ" # îšŸ
	# programs["newsboat"]="î˜™" # "ï‚"
	# programs["bitwarden"]="ï„²"
	# programs["xbps-install"]="ïƒ¢"
	# programs["signal-desktop"]="ï‰º"
	# programs["nvim"]="ï¯"
	# programs["telegram"]="îˆ—" # "ï‹†"

	mapfile -t icons < <(get_interface)
	icons+=("$(is_microphone_on)")
	icons+=("$(is_bluetooth_on)")

	for prog in "${!programs[@]}"; do
		icon=${programs[$prog]}
		icons+=("$(is_running "$prog" "$icon")")
	done

	# maybe implement option to display fallback icon if proc not running
	icons+=("$(is_running "xautolock" "î™²" "ï„¾")")

	icons+=("$(is_notifications_on)")
	icons+=("$(is_redshift_enable)")

	printf "%s" "$SEP1"
	for icon in "${icons[@]}"; do
		[[ -n "$icon" ]] && printf "%s  " "$icon"
	done
	printf "%s\n" "$SEP2"
}

main
