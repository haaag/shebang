#!/usr/bin/env bash

# Simple systray for dwmblocks

get_interface() {
	local ether="eno1"
	local wlan="wlp2s0"
	declare -A interfaces
	interfaces["$ether"]="ï›¿"
	interfaces["$wlan"]="ï‚¬"

	local exclude="loopback"
	local status=$(nmcli device status | grep "$ether\|$wlan")
	local count=$(echo "$status" | grep -c "connected")

	if [[ "$count" -lt 1 ]]; then
		printf "%s" "ï„§"
	elif [[ "$count" -eq 1 ]]; then
		local active=$(echo "$status" | grep "connected" | grep -v "$exclude" | awk '{print $1}')
		printf "%s" "${interfaces[$active]}"
	else
		printf "%s" "ğŸ”´${interfaces[*]}"
	fi
}

get_icons() {
	icons=(ï„° ï„± ï„œ ï„¾ î™² ï‡¦ ï„§ ï‡« ï€’ ïŠ“ ïŠ™ ï‹ ï‹’ ï‘¶ ï‡¶ ï’¼ îš“ î© î™ î• î“ îŸ… î˜« ï€ ï‹ ï¶ ï¬ ïª ï‚¬ ï‚­ ï‚® ïƒ¢ ï›¿ ï± î­¹ î­º î­»)
}

is_bluetooth_on() {
	if bluetoothctl show | grep -q "Powered: yes"; then
		printf "%s" "ïŠ“"
	fi
}

is_running() {
	local cmd="$1"
	local icon="$2"
	local disable="$3"

	if ! pgrep -f "$cmd" >/dev/null; then
		printf "%s" "$disable"
	else
		printf "%s" "$icon"
	fi
}

main() {
	declare -A programs
	programs["mpv"]="ï‹" # îšŸ
	programs["newsboat"]="î˜™"
	programs["nvim"]="ï¯"
	programs["signal-desktop"]="ï‰º"
	programs["telegram"]="îˆ—" # "ï‹†"
	programs["tidal-hifi"]="ï€"
	programs["transmission-daemon"]="ï¶"
	programs["xbps-install"]="ïƒ¢"
  programs["ytlocal"]="ï…ª"

	mapfile -t icons < <(get_interface)
	icons+=("$(is_bluetooth_on)")

	for prog in "${!programs[@]}"; do
		icon=${programs[$prog]}
		icons+=("$(is_running "$prog" "$icon")")
	done

	# Maybe implement option to display another icon if not running
	icons+=("$(is_running "dunst" "ï‘¶" "ï‡¶")")

	printf "%s" "$SEP1"
	for icon in "${icons[@]}"; do
		[[ -n "$icon" ]] && printf "%s " "$icon"
	done
	printf "%s\n" "$SEP2"
}

main
